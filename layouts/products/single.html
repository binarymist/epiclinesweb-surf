{{ define "main" }}

<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-md-5 mb-4 mb-md-0">
        <!-- product image slider -->
        <div class="product-image-slider">
          {{ range .Params.images }}
          
            {{/* warnf "1 our-builds/single 游릭 : %+v" ( . ) }}
            {{ warnf "2 our-builds/single 游릭 : %T" ( . ) */}}

            {{/* Create the resource from . */}}
            {{/* Fingerprint the resource */}}
            {{/* Create the copy */}}
            {{/* Pass the new resource path to data-image */}}
            {{/* Pass the new resource path to partial "image.html" */}}

            {{ $resourcePath := resources.Get . }}
            {{ $fingerprintedImage := $resourcePath | fingerprint }}
            {{- $imgResource := resources.Copy ($fingerprintedImage.RelPermalink | strings.TrimPrefix (printf "/%s" site.Params.section)) (resources.Get $resourcePath) -}}
            {{ $fingerprintedURL := $imgResource.Permalink }}

            {{/* warnf "3 our-builds/single 游릭 : %+v" $imgResource }}
            {{ warnf "4 our-builds/single 游릭 : %T" $imgResource }}
            {{ warnf "5 our-builds/single 游릭 : %+v" $imgResource.Permalink }}
            {{ warnf "6 our-builds/single 游릭 : %T" $imgResource.Permalink */}}
          
            {{/* warnf "7 our-builds/single 游릭 : %+v" $fingerprintedURL }}
            {{ warnf "8 our-builds/single 游릭 : %T" $fingerprintedURL */}}
            <div data-image="{{ $fingerprintedURL | absURL }}">
              {{ partial "image.html" (dict "Src" $fingerprintedURL "Alt" "product-image" "Class" "img-fluid w-100" ) }}
            </div>
          {{ end }}
        </div>
      </div>
      <div class="col-lg-6 col-md-7 offset-lg-1">
        <h1 class="mb-4">{{ .Title }}</h1>

        {{/* 1. Logic to identify variations */}}
        {{ $productVariations := dict }}
        {{ range $paramsKey, $paramsValue := .Params }}
          {{ if hasPrefix $paramsKey "productvariation_" }}
            {{ $variation := substr $paramsKey 17 }} <!-- remove "productvariation_" prefix -->
            {{ $productVariations = merge $productVariations (dict $variation $paramsValue) }}
          {{ end }}
        {{ end }}

        {{/* 2. Variation Display: Interactive if Snipcart is ON, Static if OFF */}}
        {{ if and site.Params.snipcart.enable .Params.featureflag_cart }}
          {{ $dropdownVariationIndex := 1 }}
          {{ range $name, $options := $productVariations }}
          <div class="variation-select-wrapper mb-4" style="position: relative; width: 250px;">
              <label class="font-weight-bold">Choose {{ $name | title }}:</label>
              <div class="variation-select-trigger" onclick="this.nextElementSibling.classList.toggle('show')"
                  style="padding: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; justify-content: space-between;">
                  <span>{{ index $options 0 | title }}</span>
                  <i class="tf-ion-ios-arrow-down"></i>
              </div>
              <ul class="variation-options-list" style="display: none; position: absolute; width: 100%; background: #fff; border: 1px solid #ccc; list-style: none; padding: 0; margin: 0; z-index: 1000;">
                  {{ range $options }}
                  <li class="variation-option" data-value="{{ . }}" data-target="data-item-custom{{ $dropdownVariationIndex }}-value" onclick="el.productVariationDropdownHandleSelection(this)" style="padding: 10px; cursor: pointer;">{{ . | title }}</li>
                  {{ end }}
              </ul>
          </div>
          {{ $dropdownVariationIndex = add $dropdownVariationIndex 1 }}
          {{ end }}
        {{ else }}
          {{ range $variation, $values := $productVariations }}
            <p><strong>{{ $variation | title }}: </strong>{{ delimit $values ", " | title }}</p>
          {{ end }}
        {{ end }}

        {{/* 3. Price Display */}}
        <p class="price py-4">{{if .Params.discount_price}}{{site.Params.currency}}{{.Params.discount_price}}{{else}}{{site.Params.currency}}{{.Params.price}}{{end}}
        {{if .Params.discount_price}}<s class="price">{{site.Params.currency}}{{ .Params.price }}</s>{{end}}
        </p>

        {{/* 4. Button Logic */}}
        {{ if and site.Params.snipcart.enable .Params.featureflag_cart }}
        <button class="snipcart-add-item btn btn-main mb-5" 
          data-item-id="{{ .Title | urlize }}"
          data-item-name="{{ .Title }}"
          data-item-image="{{- with .Params.Images -}}{{- range first 1 . -}}{{- $res := resources.Get . | fingerprint -}}{{- $res.Permalink | absURL -}}{{- end -}}{{- end -}}"
          data-item-price="{{ if .Params.discount_price }}{{ .Params.discount_price }}{{ else }}{{ .Params.price }}{{ end }}" 
          data-item-url="{{ .Permalink }}"
          {{ $buttonVariationIndex := 1 }}
          {{ range $key, $opts := $productVariations }}
            data-item-custom{{ $buttonVariationIndex }}-name="Choose {{ $key | title }}"
            data-item-custom{{ $buttonVariationIndex }}-options="{{ range $index, $value := $opts }}{{ if eq $index 0 }}{{ $value }}{{ else }}|{{ $value }}{{ end }}{{ end }}"
            {{ $buttonVariationIndex = add $buttonVariationIndex 1 }}
          {{ end }}>
          Add to Cart
        </button>
        {{ else }}
          {{ with .Params.button_link }}
            <a class="btn btn-main mb-5" href="{{ . | absURL }}">Add to Cart</a>
          {{ end }}
        {{ end }}

        <div class="content">{{.Content}}</div>
      </div>
    </div>
  </div>
</section>
{{ end }}
